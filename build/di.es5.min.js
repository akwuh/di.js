(function(global,factory){if(typeof define==="function"&&define.amd){define("di",["exports","lodash/object/extend","lodash/lang/isArray","lodash/lang/isObject","lodash/object/defaults","lodash/collection/forEach","lodash/object/values","lodash/lang/isFunction","lodash/collection/map","lodash/utility/uniqueId"],factory)}else if(typeof exports!=="undefined"){factory(exports,require("lodash/object/extend"),require("lodash/lang/isArray"),require("lodash/lang/isObject"),require("lodash/object/defaults"),require("lodash/collection/forEach"),require("lodash/object/values"),require("lodash/lang/isFunction"),require("lodash/collection/map"),require("lodash/utility/uniqueId"))}else{var mod={exports:{}};factory(mod.exports,global._lodashObjectExtend,global._lodashLangIsArray,global._lodashLangIsObject,global._lodashObjectDefaults,global._lodashCollectionForEach,global._lodashObjectValues,global._lodashLangIsFunction,global._lodashCollectionMap,global._lodashUtilityUniqueId);global.di=mod.exports}})(this,function(exports,_lodashObjectExtend2,_lodashLangIsArray2,_lodashLangIsObject2,_lodashObjectDefaults2,_lodashCollectionForEach2,_lodashObjectValues2,_lodashLangIsFunction2,_lodashCollectionMap2,_lodashUtilityUniqueId2){"use strict";var _lodashObjectExtend3=_interopRequireDefault(_lodashObjectExtend2);var _lodashLangIsArray3=_interopRequireDefault(_lodashLangIsArray2);var _lodashLangIsObject3=_interopRequireDefault(_lodashLangIsObject2);var _lodashObjectDefaults3=_interopRequireDefault(_lodashObjectDefaults2);var _lodashCollectionForEach3=_interopRequireDefault(_lodashCollectionForEach2);var _lodashObjectValues3=_interopRequireDefault(_lodashObjectValues2);var _lodashLangIsFunction3=_interopRequireDefault(_lodashLangIsFunction2);var _lodashCollectionMap3=_interopRequireDefault(_lodashCollectionMap2);var _lodashUtilityUniqueId3=_interopRequireDefault(_lodashUtilityUniqueId2);Object.defineProperty(exports,"__esModule",{value:true});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var then=function then(promise,callback){if(promise&&promise.then){return promise.then(callback)}else{return callback(promise)}};var all=function all(values,callback){var some=values.some(function(promise){return Boolean(promise&&promise.then)});if(some){return Promise.all(values).then(callback)}else{return callback(values)}};var qCatch=function qCatch(promise,callback){if(promise&&promise["catch"]){promise["catch"](callback)}return promise};var createLoader=function createLoader(require){var bundles={};require.keys().forEach(function(path){var name=path.match(/\/([^\/]+)$/)[1];bundles[name]={path:path}});return function(name){var description=bundles[name],bundleLoader=undefined;if(description){bundleLoader=require(description.path);if(typeof bundleLoader==="function"&&!bundleLoader.name){return new Promise(function(resolve){bundleLoader(resolve)})}return bundleLoader}}};var webpackResolver=function webpackResolver(requires){var bundles={};var createLoader=function createLoader(require){require.keys().forEach(function(path){var name=path.match(/\/([^\/]+)$/)[1];if(!bundles[name]){bundles[name]=function(){return require(path)}}})};requires.forEach(createLoader);return function(name){if(!name.match(/\.js$/)){name+=".js"}var require=bundles[name],bundleLoader=undefined;if(require){bundleLoader=require();if(typeof bundleLoader==="function"&&!bundleLoader.name){return new Promise(function(resolve){bundleLoader(resolve)})}return bundleLoader}}};var staticResolver=function staticResolver(hash){return function(name){return hash[name]}};var parseStringDefinition=function parseStringDefinition(definition){var matches=definition.match(/^([^.]+)(\.(.+))?$/);if(!matches){console.error(module);throw new Error("Unknown module format")}return{bundleName:matches[1],factory:matches[3]}};var normalizeDependencyDefinition=function normalizeDependencyDefinition(dependencyId,config){var definition={id:dependencyId};if(typeof config==="string"){(0,_lodashObjectExtend3["default"])(definition,parseStringDefinition(config))}else if((0,_lodashLangIsArray3["default"])(config)){if(config.length===1){(0,_lodashObjectExtend3["default"])(definition,config[0])}else{(0,_lodashObjectExtend3["default"])(definition,parseStringDefinition(config[0]),{dependencies:config[1]})}}else if((0,_lodashLangIsObject3["default"])(config)){(0,_lodashObjectExtend3["default"])(definition,parseStringDefinition(dependencyId),{dependencies:config})}else{throw new Error("Unknown type of dependency definition")}return(0,_lodashObjectDefaults3["default"])(definition,{factory:"factory"})};var normalizeDependencyDefinitions=function normalizeDependencyDefinitions(dependencies){var definitions={};(0,_lodashCollectionForEach3["default"])(dependencies,function(config,dependencyId){definitions[dependencyId]=normalizeDependencyDefinition(dependencyId,config)});return definitions};var createContainer=function createContainer(){var _ref=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var _ref$resolvers=_ref.resolvers;var resolvers=_ref$resolvers===undefined?[]:_ref$resolvers;var _ref$dependencies=_ref.dependencies;var dependencies=_ref$dependencies===undefined?{}:_ref$dependencies;var bundleCache={};var definitions=normalizeDependencyDefinitions(dependencies);var factory=function factory(definition,dependencies){var Module=definition.Module,factory=definition.factory;if(Module.__esModule===true){Module=(0,_lodashObjectValues3["default"])(Module)[0]}if(Module[factory]){return Module[factory](dependencies)}else{return new Module(dependencies)}};var loadModuleBundle=function loadModuleBundle(definition){if(definition.Module){return definition.Module}var queue=resolvers.slice(),name=definition.bundleName;var loadBundle=function loadBundle(){if(bundleCache[name]){return bundleCache[name]}var nextLoader=function nextLoader(){if(!queue.length){return Promise.reject(new Error('Cannot find bundle with name "'+definition.bundleName+'"'))}var loader=queue.shift();return then(loader(name),function(result){if(result){return bundleCache[name]=result}else{return nextLoader()}})};return bundleCache[name]=nextLoader()};return then(loadBundle(),function(Module){definition.Module=Module;return Module})};var normalizeModule=function normalizeModule(module){if(typeof module==="string"){if(definitions[module]){return definitions[module]}return definitions[module]=normalizeDependencyDefinition(module,{})}console.log("UNKNOWN MODULE",module);throw new Error("Unknown module")};var loadModule=function loadModule(moduleName,params){var definition=normalizeModule(moduleName);var load=function load(){var promises=[definition.instance?null:loadModuleBundle(definition),loadModuleDependencies(definition,params)];return all(promises,function(_ref2){var _ref22=_slicedToArray(_ref2,2);var Module=_ref22[0];var dependencies=_ref22[1];var _factory=function _factory(){if(definition.instance){return definition.instance}else{return factory(definition,dependencies)}};return then(_factory(),function(instance){var isNeedUpdate=!params.diSessionId||definition.diSessionId!==params.diSessionId;definition.diSessionId=params.diSessionId;if((0,_lodashLangIsFunction3["default"])(instance.updateDependencies)){if(isNeedUpdate){return then(instance.updateDependencies(dependencies),function(_){return instance})}}return instance})})};if(definition._progress){return definition._progress}definition._progress=then(load(),function(instance){definition.instance=instance;return instance});return then(definition._progress,function(instance){definition._progress=null;return instance})};var loadModules=function loadModules(dependencies,params){var loaded=(0,_lodashObjectExtend3["default"])({},params);if(dependencies){var promises=(0,_lodashCollectionMap3["default"])(dependencies,function(dependencyName,key){return then(loadModule(dependencyName,params),function(dependency){return loaded[key]=dependency})});return all(promises,function(_){return loaded})}return loaded};var loadModuleDependencies=function loadModuleDependencies(definition,params){return loadModules(definition.dependencies,params)};var di=function di(module,params){var promise=undefined;params=params||{};if(typeof module==="string"){promise=loadModule(module,params)}else{promise=loadModules(module,params)}qCatch(promise,function(err){console.error(err);console.error(err.stack)});return promise};di.session=function(){var id=(0,_lodashUtilityUniqueId3["default"])("di");return{load:function load(module,params){params=params||{};params.diSessionId=id;return di(module,params)},close:function close(){(0,_lodashCollectionForEach3["default"])(definitions,function(module){var instance=module.instance;if(module.diSessionId&&module.diSessionId!==id&&instance){if(instance.trigger){instance.trigger("di:destroy")}if((0,_lodashLangIsFunction3["default"])(instance.destroy)){instance.destroy()}module.instance=null}})}}};di.put=function(inputDefinition,instance){var definition=normalizeModule(inputDefinition);definition.instance=instance;return undefined};return di};exports.createContainer=createContainer;exports.webpackResolver=webpackResolver;exports.staticResolver=staticResolver;exports.then=then;exports.all=all;exports.qCatch=qCatch});